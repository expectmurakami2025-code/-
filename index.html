<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ねこの成長チェック＋体長計測（写真 or スマホ計測値）</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --card:#ffffff;
    --grad1:#ff6b6b; --grad2:#22c55e; --grad3:#3b82f6; --grad4:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 20% 10%, #fff1f1, transparent),
      radial-gradient(1200px 800px at 80% 20%, #f1fff4, transparent),
      radial-gradient(1200px 800px at 50% 90%, #f1f6ff, transparent),
      #f8fafc;
    font-family: system-ui, -apple-system, "Segoe UI", Meiryo, Arial, sans-serif;
  }
  header{padding:18px 16px 8px}
  h1{margin:.2rem 0;font-size:clamp(20px,4.2vw,34px);letter-spacing:.02em}
  .muted{color:var(--muted)}
  main{max-width:1180px;margin:auto;padding:12px}
  .card{
    background:var(--card); border-radius:16px; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
    border:1px solid rgba(0,0,0,.06);
  }
  .grid{display:grid;gap:14px}
  @media(min-width:980px){.grid-2{grid-template-columns:1fr 1fr}}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .btn{border:none;color:#fff;font-weight:700;cursor:pointer}
  .btn-p{background:linear-gradient(90deg,var(--grad1),#ff8e53)}
  .btn-g{background:linear-gradient(90deg,var(--grad2),#10b981)}
  .btn-b{background:linear-gradient(90deg,var(--grad3),#60a5fa)}
  .btn-a{background:linear-gradient(90deg,var(--grad4),#fbbf24); color:#111}
  .btn-ghost{background:#fff;color:#111;border:2px solid #e5e7eb}
  .pill{display:inline-block;padding:.28rem .7rem;border-radius:999px;font-weight:700;font-size:.9rem}
  .pill-info{background:rgba(59,130,246,.12);color:#1d4ed8}
  .pill-ok{background:rgba(34,197,94,.12);color:#15803d}
  .pill-warn{background:rgba(245,158,11,.16);color:#92400e}
  .pill-bad{background:rgba(239,68,68,.14);color:#b91c1c}
  canvas{max-width:100%;height:360px}
  /* --- 埋め込み：写真から体長を測る --- */
  .wrap{position:relative; overflow:hidden; border-radius:14px;
    background: repeating-conic-gradient(from 0deg, #f3f4f6 0 25%, #e5e7eb 0 50%) 50%/16px 16px;}
  .stage{position:relative; width:100%; height:68vh; min-height:360px; background:#fff; touch-action:none;}
  .stage img{position:absolute; top:0; left:0; transform-origin:0 0; image-rendering:auto; max-width:none;}
  .stage canvas{position:absolute; inset:0; pointer-events:none}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .row > *{flex:1}
  .badge{font-weight:800; padding:2px 8px; border-radius:8px}
  .badge-ref{background:#eff6ff;color:#1d4ed8}
  .badge-cat{background:#ecfeff;color:#0e7490}
  footer{padding:16px;color:#6b7280}
</style>
</head>
<body>
<header>
  <h1>ねこの成長チェック <span class="pill pill-info">将来体重予測つき</span></h1>
  <p class="muted">体重・月齢・猫種から「今は順調？」を判定。<b>写真 or スマホの計測アプリで測った体長</b>も入力できます。</p>
</header>

<main class="grid grid-2">
  <!-- 左：成長チェック -->
  <section class="card" id="growthCard">
    <h3>ねこの成長チェック＆将来体重予測</h3>
    <div class="grid">
      <div>
        <label>体重（kg）
          <input type="number" id="weight" step="0.01" min="0.1" placeholder="例) 1.25">
        </label>
      </div>
      <div>
        <label>月齢（月）
          <input type="number" id="age" step="0.1" min="0" placeholder="例) 3.5">
        </label>
      </div>
      <div>
        <label>性別
          <select id="sex">
            <option value="unknown">不明/未設定</option>
            <option value="male">オス</option>
            <option value="female">メス</option>
          </select>
        </label>
      </div>
      <div>
        <label>猫種
          <select id="breed"></select>
        </label>
      </div>
      <div>
        <label>体長（cm）<small class="muted">（任意：外部計測アプリ or 写真計測の値を入力）</small>
          <input type="number" id="bodyLen" step="0.1" min="1" placeholder="例) 28.0">
        </label>
      </div>
    </div>

    <div class="toolbar" style="margin-top:8px">
      <button id="calc" class="btn btn-p">判定・予測する</button>
      <button id="save" class="btn-ghost">履歴に保存</button>
      <button id="clearHist" class="btn-ghost">履歴を全消去</button>
      <button id="openMeasure" class="btn btn-b">写真から体長を測る（埋め込みツール）</button>
    </div>

    <details style="margin-top:8px">
      <summary>高度設定（任意）</summary>
      <small class="muted">去勢・避妊済み → 成猫体重の上限がわずかに上がる場合があるため、+5%補正。</small><br>
      <label style="margin-top:6px"><input type="checkbox" id="neutered"> 去勢/避妊済み</label>
    </details>

    <article class="card" id="resultCard" style="display:none; margin-top:12px; background:linear-gradient(135deg,#fff 0%, #fff7ed 50%, #f0f9ff 100%);">
      <h4>判定結果</h4>
      <p id="statusPill" class="pill"></p>
      <p id="summary"></p>
      <ul>
        <li id="adultRange"></li>
        <li id="adultPred"></li>
        <li id="lenNote" class="muted"></li>
      </ul>
      <canvas id="chart"></canvas>
      <p class="muted" style="margin-top:8px">灰色帯＝標準域（±15%・月齢4か月未満は±20%）。曲線＝あなたのねこの予測カーブ。</p>
    </article>

    <article class="card" style="margin-top:12px">
      <h4>記録（この端末に保存）</h4>
      <div style="overflow:auto">
        <table id="historyTable">
          <thead><tr><th>日時</th><th>体重(kg)</th><th>月齢</th><th>性別</th><th>猫種</th><th>体長(cm)</th><th>判定</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </article>
  </section>

  <!-- 右：写真から体長を測る（埋め込み） -->
  <section class="card" id="photoTool">
    <h3>写真からねこの体長を測る <span class="pill pill-info">スマホOK</span></h3>
    <p class="muted">スマホの写真で、<b>基準物</b>（A4、ICカード、500円玉、定規など）と<b>猫</b>に2点ずつ線を引くだけで体長が出ます。外部の「計測」アプリで測った値を直接入力してもOK。</p>

    <div class="grid">
      <div>
        <label>写真を選ぶ（スマホの写真OK）
          <input id="file" type="file" accept="image/*" />
        </label>
      </div>
      <div>
        <label>基準物の種類</label>
        <select id="refType">
          <option value="custom">任意の長さを入力</option>
          <option value="ic">ICカードの横 8.56 cm</option>
          <option value="a4short">A4の短辺 21.0 cm</option>
          <option value="a4long">A4の長辺 29.7 cm</option>
          <option value="coin500">500円玉の直径 2.65 cm</option>
        </select>
      </div>
      <div id="customLenBox">
        <label>任意の長さ（cm）
          <input id="customLen" type="number" step="0.01" min="0.01" value="10.00">
        </label>
        <small class="muted">例：定規の1〜10cmを映して「10cm」と入力</small>
      </div>
    </div>

    <div class="grid">
      <div>
        <label>ズーム（%）
          <input id="zoom" type="range" min="50" max="400" step="1" value="100">
        </label>
      </div>
      <div class="row">
        <label><input id="snap45" type="checkbox"> 角度を±45°でスナップ</label>
        <button id="modeRef" class="btn btn-b">① 基準線モード</button>
        <button id="modeCat" class="btn btn-g">② 体長線モード</button>
        <button id="undo" class="btn-ghost">UNDO</button>
        <button id="clear" class="btn btn-a">全クリア</button>
      </div>
    </div>

    <div class="wrap" style="margin-top:10px">
      <div class="stage" id="stage">
        <img id="img" alt="">
        <canvas id="overlay"></canvas>
      </div>
    </div>

    <article class="card" style="margin-top:10px; background:linear-gradient(135deg,#fff 0%, #f0f9ff 100%);">
      <p class="badge badge-ref">基準線</p>
      <p>写真上で <b>2回タップ／クリック</b>して、基準物の端→端に線を引いてください。</p>
      <p class="badge badge-cat">体長線</p>
      <p>次に、猫の <b>鼻先</b> と <b>尾の付け根</b> に2点打つと体長が出ます。</p>
      <p id="outRef" class="muted">基準：未設定</p>
      <p id="outLen"><b>体長：</b>— cm</p>
      <div class="toolbar">
        <button id="sendToForm" class="btn btn-p">↑ 成長チェックに体長を送る</button>
      </div>
      <small class="muted">※ 外部の「計測」アプリで測った長さは、左側の「体長（cm）」欄に直接入力でもOKです。</small>
    </article>
  </section>
</main>

<footer>
  <p>※ WebからiOS/Androidの「計測」アプリの数値を自動取得することはできません。手入力または本ページの写真計測をご利用ください。体重の急変や食欲低下・元気がない等があれば月齢に関係なく獣医師へ。</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
/* ---------- 成長チェック（前作のロジック＋一部拡張） ---------- */
const BREEDS = [
  {name:"ミックス（標準）", key:"mix", size:"medium", male:[3.8,5.0], female:[3.0,4.2], unknown:[3.4,4.6]},
  {name:"アメリカン・ショートヘア", key:"ash", size:"medium", male:[4.0,6.8], female:[3.2,5.0], unknown:[3.6,5.9]},
  {name:"ブリティッシュ・ショートヘア", key:"bsh", size:"medium", male:[5.0,8.0], female:[4.0,6.0], unknown:[4.5,7.0]},
  {name:"メインクーン", key:"maine", size:"large", male:[6.0,9.0], female:[4.0,6.0], unknown:[5.0,7.5]},
  {name:"ノルウェージャン・フォレスト", key:"norwegian", size:"large", male:[5.0,9.0], female:[4.0,6.5], unknown:[4.5,7.5]},
  {name:"ラグドール", key:"ragdoll", size:"large", male:[5.0,9.0], female:[4.0,7.0], unknown:[4.5,8.0]},
  {name:"スコティッシュフォールド", key:"scottish", size:"small", male:[3.0,5.0], female:[2.5,4.5], unknown:[2.8,4.8]},
  {name:"シャム（サイアミーズ）", key:"siamese", size:"small", male:[3.0,5.0], female:[2.5,4.2], unknown:[2.8,4.6]},
  {name:"マンチカン", key:"munchkin", size:"small", male:[2.7,4.2], female:[2.3,3.6], unknown:[2.5,3.9]},
  {name:"ベンガル", key:"bengal", size:"medium", male:[4.5,7.0], female:[3.5,5.5], unknown:[4.0,6.2]},
  {name:"ペルシャ", key:"persian", size:"medium", male:[3.5,5.5], female:[3.0,4.5], unknown:[3.2,5.0]}
];

const FRACTIONS = {
  small:  {months:[0,1,2,3,4,6,8,10,12,15,18,24], fracs:[0,0.12,0.25,0.35,0.45,0.65,0.80,0.90,1.00,1.00,1.00,1.00]},
  medium: {months:[0,1,2,3,4,6,8,10,12,15,18,24], fracs:[0,0.10,0.23,0.33,0.43,0.63,0.78,0.90,1.00,1.00,1.00,1.00]},
  large:  {months:[0,1,2,3,4,6,8,10,12,15,18,24], fracs:[0,0.08,0.20,0.30,0.40,0.58,0.72,0.85,0.93,0.98,1.00,1.00]}
};
function lerp(x0,y0,x1,y1,x){ if (x1===x0) return y0; return y0 + (y1-y0)*((x-x0)/(x1-x0)); }
function fracAt(months, fracs, m){
  if (m<=months[0]) return fracs[0];
  for (let i=1;i<months.length;i++){
    if (m<=months[i]) return lerp(months[i-1], fracs[i-1], months[i], fracs[i], m);
  }
  return fracs[fracs.length-1];
}
const breedSel = document.getElementById('breed');
BREEDS.forEach(b=>{ const o=document.createElement('option'); o.value=b.key; o.textContent=b.name; breedSel.appendChild(o) });

function getBreedEntry(key){ return BREEDS.find(b=>b.key===key) || BREEDS[0]; }
function getAdultRange(breedKey, sex, neutered=false){
  const b = getBreedEntry(breedKey);
  const range = b[sex] || b.unknown;
  const [min,max] = neutered ? [range[0], range[1]*1.05] : range;
  return [min, max];
}
function mid([a,b]){ return (a+b)/2; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function sizeOf(breedKey){ return getBreedEntry(breedKey).size; }
function fractionFor(size, m){ const S = FRACTIONS[size] || FRACTIONS.medium; return fracAt(S.months, S.fracs, m); }

function predict({weight, age, breedKey, sex, neutered}){
  const size = sizeOf(breedKey);
  const frac = Math.max(0.01, fractionFor(size, age));
  const [minA, maxA] = getAdultRange(breedKey, sex, neutered);
  const midA = mid([minA, maxA]);
  let impliedAdult = weight / frac;
  const looseMin = minA * 0.8, looseMax = maxA * 1.2;
  impliedAdult = clamp(impliedAdult, looseMin, looseMax);
  const confidence = Math.min(0.85, Math.max(0.2, frac + 0.15));
  const adultPred = confidence * impliedAdult + (1 - confidence) * midA;
  const expectedNow = midA * frac;
  const tol = (age < 4) ? 0.20 : 0.15;
  const lower = expectedNow * (1 - tol);
  const upper = expectedNow * (1 + tol);
  let status="順調", badge="pill-ok";
  if (weight < lower*0.85) { status="かなり軽め"; badge="pill-bad"; }
  else if (weight < lower) { status="やや軽め"; badge="pill-warn"; }
  else if (weight > upper*1.15) { status="かなり重め"; badge="pill-bad"; }
  else if (weight > upper) { status="やや重め"; badge="pill-warn"; }

  return { status, badge, adultRange:[minA,maxA], adultPred:[adultPred*0.92, adultPred*1.08], expectedNow, lower, upper, size, frac, confidence };
}

let chart;
function drawChart(pred){
  const ctx = document.getElementById('chart');
  const months = []; for (let m=0; m<=24; m+=(m<12?1:2)) months.push(m);
  const midA = mid(pred.adultRange), size = pred.size;
  const standard = months.map(m => midA * fractionFor(size, m));
  const bandLow = standard.map((v,i) => v * (months[i]<4?0.8:0.85));
  const bandHigh= standard.map((v,i) => v * (months[i]<4?1.20:1.15));
  const adultMid = mid(pred.adultPred);
  const yourCurve = months.map(m => adultMid * fractionFor(size, m));
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels:months, datasets:[
      {label:'標準域 上限', data:bandHigh, borderWidth:0, pointRadius:0, fill:false},
      {label:'標準域 下限', data:bandLow, borderWidth:0, pointRadius:0, fill:'-1', backgroundColor:'rgba(0,0,0,0.06)'},
      {label:'あなたの予測', data:yourCurve, borderWidth:2, pointRadius:0, tension:0.25}
    ]},
    options:{responsive:true, plugins:{legend:{display:false}, tooltip:{callbacks:{label:(c)=>`${c.parsed.y.toFixed(2)} kg @ ${c.label}か月`}}},
      scales:{x:{title:{display:true,text:'月齢（か月）'}}, y:{title:{display:true,text:'体重（kg)'}}}
    }
  });
}

function formatKgRange([a,b]){ return `${a.toFixed(1)}〜${b.toFixed(1)} kg`; }

function handleCalc(){
  const weight = parseFloat(document.getElementById('weight').value);
  const age = parseFloat(document.getElementById('age').value);
  const sex = document.getElementById('sex').value;
  const breedKey = document.getElementById('breed').value || 'mix';
  const neutered = document.getElementById('neutered').checked;
  const bodyLen = parseFloat(document.getElementById('bodyLen').value);

  if (!(weight>0) || !(age>=0)){ alert('体重と月齢を入力してください'); return; }
  const pred = predict({weight, age, breedKey, sex, neutered});
  const card = document.getElementById('resultCard'); card.style.display='block';

  const pill = document.getElementById('statusPill'); pill.className = 'pill ' + (pred.badge); pill.textContent = `判定：${pred.status}`;
  document.getElementById('summary').innerHTML =
    `今の標準目安は <b>${pred.expectedNow.toFixed(2)} kg</b>（許容 ${pred.lower.toFixed(2)}〜${pred.upper.toFixed(2)}）。<br>
     入力体重 <b>${weight.toFixed(2)} kg</b> はこの帯${(weight<pred.lower||weight>pred.upper)?'の外':'の中'}です。`;
  document.getElementById('adultRange').textContent = `猫種の成猫レンジ：${formatKgRange(pred.adultRange)}`;
  document.getElementById('adultPred').textContent = `推定成猫体重：${formatKgRange(pred.adultPred)}（信頼度 ${(pred.confidence*100).toFixed(0)}%）`;
  document.getElementById('lenNote').textContent =
    (bodyLen>0) ? `参考：入力された体長は ${bodyLen.toFixed(1)} cm。継続記録で「伸びの様子」を見るのが有効です。` :
                  `体長を入れると成長の継続管理に役立ちます（上の「写真から計測」や外部計測アプリをご利用ください）。`;
  drawChart(pred);
  return {pred, weight, age, sex, breedKey, neutered, bodyLen};
}

/* 履歴 */
const TBODY = document.querySelector('#historyTable tbody');
function loadHistory(){
  const arr = JSON.parse(localStorage.getItem('catGrowthHistory')||'[]');
  TBODY.innerHTML='';
  for (const r of arr){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(r.ts).toLocaleString()}</td>
      <td>${r.weight.toFixed(2)}</td>
      <td>${r.age.toFixed(1)}</td>
      <td>${({unknown:'-',male:'オス',female:'メス'})[r.sex]||'-'}</td>
      <td>${getBreedEntry(r.breedKey).name}</td>
      <td>${r.bodyLen>0? r.bodyLen.toFixed(1):'-'}</td>
      <td>${r.status}</td>`;
    TBODY.appendChild(tr);
  }
}
function saveHistory(row){
  const arr = JSON.parse(localStorage.getItem('catGrowthHistory')||'[]');
  arr.unshift(row);
  localStorage.setItem('catGrowthHistory', JSON.stringify(arr.slice(0,100)));
  loadHistory();
}
document.getElementById('calc').addEventListener('click', ()=>{
  const res = handleCalc(); window._lastCalc = res;
});
document.getElementById('save').addEventListener('click', ()=>{
  if (!window._lastCalc){ const res = handleCalc(); if (!res) return; }
  const {pred, weight, age, sex, breedKey, neutered, bodyLen} = window._lastCalc;
  saveHistory({ ts: Date.now(), weight, age, sex, breedKey, neutered, status: pred.status, bodyLen: bodyLen||null });
});
document.getElementById('clearHist').addEventListener('click', ()=>{
  if (confirm('履歴をすべて消去しますか？')){ localStorage.removeItem('catGrowthHistory'); loadHistory(); }
});
document.getElementById('openMeasure').addEventListener('click', ()=>{
  document.getElementById('photoTool').scrollIntoView({behavior:'smooth'});
});
loadHistory();

/* ---------- 写真から体長を測る（埋め込みツール） ---------- */
const stage = document.getElementById('stage');
const img = document.getElementById('img');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
let imgW=0,imgH=0, scale=1, offsetX=0, offsetY=0;
let mode='ref'; // 'ref' or 'cat'
let pointsRef=[], pointsCat=[];
let historyStack=[];
const outRef=document.getElementById('outRef');
const outLen=document.getElementById('outLen');

function setMode(m){ mode=m; document.getElementById('modeRef').ariaSelected=(m==='ref'); document.getElementById('modeCat').ariaSelected=(m==='cat'); }
document.getElementById('modeRef').addEventListener('click',()=>setMode('ref'));
document.getElementById('modeCat').addEventListener('click',()=>setMode('cat'));

document.getElementById('file').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{ img.src=reader.result; };
  reader.readAsDataURL(f);
});

img.onload=()=>{
  imgW=img.naturalWidth; imgH=img.naturalHeight;
  scale=stage.clientWidth/imgW; if (imgH*scale>stage.clientHeight) scale=stage.clientHeight/imgH;
  offsetX=(stage.clientWidth-imgW*scale)/2; offsetY=(stage.clientHeight-imgH*scale)/2;
  img.style.transform=`translate(${offsetX}px,${offsetY}px) scale(${scale})`;
  overlay.width=stage.clientWidth; overlay.height=stage.clientHeight;
  pointsRef=[]; pointsCat=[]; historyStack=[]; drawOverlay();
};

function toImgSpace(px,py){ return [(px - offsetX)/scale, (py - offsetY)/scale]; }
function fromImgSpace(ix,iy){ return [ix*scale + offsetX, iy*scale + offsetY]; }

function drawLine(p1,p2,color,width=3){
  ctx.strokeStyle=color; ctx.lineWidth=width; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(...fromImgSpace(...p1)); ctx.lineTo(...fromImgSpace(...p2)); ctx.stroke();
}
function drawOverlay(){
  ctx.clearRect(0,0,overlay.width,overlay.height);
  if (pointsRef.length===2) drawLine(pointsRef[0],pointsRef[1],'#3b82f6',4);
  if (pointsCat.length===2) drawLine(pointsCat[0],pointsCat[1],'#10b981',4);
}

function distance(p1,p2){ const dx=p1[0]-p2[0], dy=p1[1]-p2[1]; return Math.hypot(dx,dy); }

function maybeSnap(p1,p2){
  if (!document.getElementById('snap45').checked) return p2;
  const dx=p2[0]-p1[0], dy=p2[1]-p1[1]; const ang=Math.atan2(dy,dx);
  const step=Math.PI/4; const snapped=Math.round(ang/step)*step;
  const len=Math.hypot(dx,dy);
  return [p1[0]+Math.cos(snapped)*len, p1[1]+Math.sin(snapped)*len];
}

stage.addEventListener('pointerdown', e=>{
  if (!img.src) return;
  const rect=stage.getBoundingClientRect();
  let x=e.clientX-rect.left, y=e.clientY-rect.top;
  const p = toImgSpace(x,y);
  if (mode==='ref'){
    if (pointsRef.length<2){ pointsRef.push(p); historyStack.push({type:'ref',p:[...p]}); if(pointsRef.length===2){ pointsRef[1]=maybeSnap(pointsRef[0],pointsRef[1]); } }
    else { pointsRef=[p]; historyStack.push({type:'ref',p:[...p]}); }
  }else{
    if (pointsCat.length<2){ pointsCat.push(p); historyStack.push({type:'cat',p:[...p]}); if(pointsCat.length===2){ pointsCat[1]=maybeSnap(pointsCat[0],pointsCat[1]); } }
    else { pointsCat=[p]; historyStack.push({type:'cat',p:[...p]}); }
  }
  updateOutputs(); drawOverlay();
});

document.getElementById('undo').addEventListener('click',()=>{
  const last=historyStack.pop(); if(!last) return;
  if (last.type==='ref') pointsRef.pop(); else pointsCat.pop();
  updateOutputs(); drawOverlay();
});
document.getElementById('clear').addEventListener('click',()=>{
  pointsRef=[]; pointsCat=[]; historyStack=[]; updateOutputs(); drawOverlay();
});

document.getElementById('zoom').addEventListener('input', e=>{
  const prevScale=scale;
  const rect=stage.getBoundingClientRect();
  const cx=rect.width/2, cy=rect.height/2;
  const [ix,iy]=toImgSpace(cx,cy);
  scale = parseFloat(e.target.value)/100 * (stage.clientWidth/imgW);
  if (imgH*scale>stage.clientHeight) scale=stage.clientHeight/imgH * (parseFloat(e.target.value)/100)/(stage.clientHeight/imgH);
  const [nx,ny]=fromImgSpace(ix,iy);
  offsetX += cx - nx; offsetY += cy - ny;
  img.style.transform=`translate(${offsetX}px,${offsetY}px) scale(${scale})`;
  drawOverlay();
});

const refTypeEl=document.getElementById('refType'); const customBox=document.getElementById('customLenBox'); const customLenEl=document.getElementById('customLen');
function refLengthCm(){
  switch(refTypeEl.value){
    case 'ic': return 8.56;
    case 'a4short': return 21.0;
    case 'a4long': return 29.7;
    case 'coin500': return 2.65;
    default: return parseFloat(customLenEl.value)||0;
  }
}
refTypeEl.addEventListener('change',()=>{ customBox.style.display = (refTypeEl.value==='custom')?'block':'none'; updateOutputs(); });
customLenEl.addEventListener('input', updateOutputs);

function updateOutputs(){
  const R = (pointsRef.length===2) ? distance(pointsRef[0],pointsRef[1]) : 0;
  const C = refLengthCm();
  if (R>0 && C>0){
    const cmPerPx = C / R;
    outRef.textContent = `基準：${C.toFixed(2)} cm（${R.toFixed(1)} px → ${cmPerPx.toFixed(4)} cm/px）`;
  }else{
    outRef.textContent = '基準：未設定';
  }
  if (pointsCat.length===2){
    const Lpx = distance(pointsCat[0],pointsCat[1]);
    let text='— cm';
    if (R>0 && C>0){
      const Lcm = Lpx * (C/R);
      text = `${Lcm.toFixed(1)} cm`;
      outLen.innerHTML = `<b>体長：</b>${text}`;
      // 一時保存（送るボタンでフォームに反映）
      window._lastMeasuredLen = Lcm;
    }else{
      outLen.innerHTML = `<b>体長：</b>${Lpx.toFixed(1)} px（基準未設定）`;
      window._lastMeasuredLen = null;
    }
  }else{
    outLen.innerHTML = `<b>体長：</b>— cm`;
    window._lastMeasuredLen = null;
  }
}

document.getElementById('sendToForm').addEventListener('click',()=>{
  if (window._lastMeasuredLen>0){
    document.getElementById('bodyLen').value = window._lastMeasuredLen.toFixed(1);
    // スクロールして成長チェックへ
    document.getElementById('growthCard').scrollIntoView({behavior:'smooth'});
  }else{
    alert('体長が算出できていません。基準線と体長線を2点ずつ指定してください。');
  }
});

/* 画像ドラッグ移動 */
let dragging=false, lastX=0, lastY=0;
stage.addEventListener('pointerdown', e=>{
  if (e.pointerType==='touch' || e.buttons===1){ dragging=true; lastX=e.clientX; lastY=e.clientY; stage.setPointerCapture(e.pointerId); }
});
stage.addEventListener('pointermove', e=>{
  if(!dragging) return;
  const dx=e.clientX-lastX, dy=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY;
  offsetX+=dx; offsetY+=dy; img.style.transform=`translate(${offsetX}px,${offsetY}px) scale(${scale})`; drawOverlay();
});
stage.addEventListener('pointerup', ()=>{ dragging=false; });
stage.addEventListener('pointercancel', ()=>{ dragging=false; });

/* 初期状態 */
setMode('ref'); customBox.style.display='block';
</script>
</body>
</html>
